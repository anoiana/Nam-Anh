---
title: "Bayesian Meta Analysis"
subtitle: "010101"
params:
  printcode: TRUE
description: |
author:
  - name: Nam Anh
date: "Nov. 20, 2021"
bibliography: citation.bib
output:
  distill::distill_article:
    toc: true
    toc_depth: 3
    code_folding: hide
---

\newcommand{\v}[1]{\boldsymbol{#1}}
\newcommand{\hat}[1]{\widehat{#1}}
\newcommand{\mm}[1]{\mathbb{#1}}
\newcommand{\bar}[1]{\overline{#1}}

\def\E{\Bbb{E}}
\def\V{\Bbb{V}}
\def\P{\Bbb{P}}
\def\I{{\large\unicode{x1D7D9}}}
\def\indep{\perp\!\!\!\!\perp}
\newcommand{\overeq}[2]{\stackrel{#1}{#2}}
\def\epsilon{\varepsilon} 

# Introduction to 2 arm analysis

We shall consider a set of M studies in which each study is denoted by $i \in \{1,\dots,M\}$ and has 2 treatment arms, say $k \in \{1,2\}$. A fixed effects analysis assumes study $i$ generates the same parameter $d_{12}$, a relative effect of treatment $2$ and $1$. The relative effect is denoted $\delta_{i,12}$ in random effect analysis and specific to study $i$. This means $\delta_{i,12}$ is a trial-specific effect of treatment $2$ and $1$ in study $i$. In Bayesian framework, $\delta_{i,12}$ is distributed normally as follows 

$$
\delta_{i,12} \sim \mathcal{N}(d_{12},\sigma^2_{12}),
$$

in fixed effects analysis, $\sigma^2_{12} = 0$ that means $\delta_{i,12} = d_{12}, \forall i$. Distribution of $d_{12}$ is known as prior distribution, and the common distribution used such a prior distribution is normal, so

$$
d_{12} \sim \mathcal{N}(0, 100^2)
$$

Distribution of between-study variance $\sigma^2_{12}$ widely used is uniform whose lower bound is zero and upper bound is chosen suitably according to knowledge of researcher.

# Meta analysis of binomial data

Let us consider 11 studies ($M=11$), each study compares 2 treatments, active and control arm. Let $r_{ik}$ and $n_{ik}$ be the number of event and sample size in arm $k$ of trial $i$, respectively. Thus,

$$
r_{ik} \sim \mathcal{B} in(p_{ik},n_{ik}).
$$

Link function used to model probability of events is logit, $logit(x) = x/(1-x)$, so 

$$
logit(p_{ik}) = \mu_i + \delta_{i,1k}.
$$

Recall that $\delta_{i,1k}$ is relative effect of treatment $k$ compared with treatment $1$, so $\delta_{i,11} = 0, \forall i$. $\delta_{i1k}$ is equal to $d_{1k}$ in fixed effect analysis. 

Prior distributions chosen for parameters are 

$$
\mu_i \sim \mathcal{N}(0,100^2); \quad \delta_{i,12} \sim \mathcal{N}(d_{12}, \sigma^2_{12}),
$$

and

$$
\sigma^2_{12} \sim \mathcal{U}(0,2)
$$

```{r, eval= params$printcode}
library(rjags); library(tidyverse); library(magrittr)
load("_data/thrombolytic.RData")

data = purrr::splice(d, "ns" = nrow(d$r))

model_string <- textConnection(
"model{ # *** PROGRAM STARTS
for(i in 1:ns){ # LOOP THROUGH STUDIES
mu[i] ~ dnorm(0,.0001) # vague priors for all trial baselines
for (k in 1:2) { # LOOP THROUGH ARMS
r[i,k] ~ dbin(p[i,k],n[i,k]) # binomial likelihood
logit(p[i,k]) <- mu[i] + d[k] # model for linear predictor
}
}
d[1]<- 0 # treatment effect is zero for reference treatment
d[2] ~ dnorm(0,.0001) # vague prior for treatment effect
}"
)
# *** PROGRAM ENDS

inits <- list(d=c( NA, -1), mu=c(-3,-3,-3,-3,-3, -3,-3,-3,-3,-3, -3))
model <- jags.model(model_string,data = data, inits=inits, n.chains=2, quiet = T)

update(model, 10000, progress.bar="none")

parameters <- c("d[2]")
samples <- coda.samples(model,
                           variable.names=parameters,
                           n.iter=20000, progress.bar="none")

s = summary(samples)
```

Running MCMC using code above, we obtain summary statistics as follows

```{r, eval = params$printcode}
lift_dv(tibble)(c(s[[1]][1:2], s[[2]]))%>%
     knitr::kable()
```

# Forward to indirect network meta-analysis

Two arm studies were considered in previous section, we now extend the result by including studies with more than two arms. It means we will consider $\delta_{i,1k}$ with $k = 1,2,\dots,S$. It is worth noting that the transitivity relation is supposed to be true, which means

$$
\delta_{i,kk'} = \delta_{i,1k'} - \delta_{i,1k},
$$

and that is called *indirect treatment comparison (ITC)*. Its prior distribution is

$$
\delta_{i,kk'} \sim \mathcal{N}(d_{kk'}, \sigma^2_{kk'}), \quad k \ne k'
$$

It can be shown that the above prior distribution impies 

$$
d_{kk'} = d_{1k'} - d_{1k}
$$ 
and 

$$
\sigma^2_{kk'} = \sigma^2_{1k}+\sigma^2_{1k'} - 2\rho^{(1)}_{23}\sigma_{12}\sigma_{13}.
$$

For simplicity, we will assume that $\sigma^2_{1k} = \sigma^2_{1k'}$ with $k \ne k'$ and $k,k' \ge 2$. This assumption is reasonable since we suppose population in all studies are the same, and trial designs are also similar across studies. 

To allow comparison for multiple treatments, notations are revised such that arm $k$ of trial $i$ and treatments compared in that arm are distinguishable. The relative effect of the treatment in arm $k$ and the treatment in arm $1$ in trial $i$ is $\delta_{ik}$ and it is distributed normally 

$$
\delta_{ik} \sim \mathcal{N}(d_{t_{i1},t_{ik}}, \sigma^2),
$$

where $d_{t_{i1},t_{ik}}$ is mean of relative effect between treatment in arm $k$ and treatment in arm $1$ of trial $i$, and $\delta_{i1} = 0, \forall i$. The general consistency equation is

$$
d_{t_{i1},t_{ik}} = d_{1,t_{ik}} - d_{1,t_{ik}}
$$

$d_{1k}$ with $k=1,2,\dots,S$ are estimated, and to provide non-informative prior we assume

$$
d_{1k} \sim \mathcal{N}(0, 100^2)
$$

## Multi-arm trials

Suppose each study $i$ has $a_i+1$ treatments (1 reference, e.g. control or placebo, and $a_i$ treatments), so all effect measures of treatment in arm $k$ compared with treatment in arm $1$ are $\v{\delta}_i = (\delta_{i,12}, \delta_{i,13}, \dots, \delta_{i,1a_i})^{\top}$ and 

$$
\v{\delta}_i = (\delta_{i,12}, \delta_{i,13}, \dots, \delta_{i,1a_i})^{\top} \sim \mathcal{N}_{a_i}\begin{pmatrix}
\begin{pmatrix}
d_{t_{i1},t_{i2}}\\
d_{t_{i1},t_{i3}}\\
\vdots\\
d_{t_{i1},t_{ia_i}}
\end{pmatrix},
\begin{pmatrix}
\sigma^2 & \sigma^2/2 & \dots & \sigma^2/2 \\
\vdots & \vdots & \ddots & \vdots \\
\sigma^2/2 & \sigma^2/2 & \dots & \sigma^2
\end{pmatrix}
\end{pmatrix}
$$
and we can show that

$$
\delta_{i,1k}|(\delta_{i,12}, \dots, \delta_{i,1(k-1)})^{\top} \sim \mathcal{N}\Bigg(
(d_{1,t_{ik}}-d_{1,t_{Ã­}})+\frac{1}{k-1}\sum^{k-1}_{j=1}\Big[\delta_{i,1j}-\big(d_{1,t_{ij}}-d_{1,t_{i1}}\big)\Big],
\frac{k}{2(k-1)}\sigma^2
\Bigg)
$$

## Example

We shall consider the following example for illustration. 














 