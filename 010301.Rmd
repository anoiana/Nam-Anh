---
title: "Bayesian Sample Size Determination"
subtitle: "010301"
params:
  printcode: FALSE
description: |
author:
  - name: Nam Anh
date: "Nov. 20, 2021"
bibliography: citation.bib
csl: citation.csl
output:
  distill::distill_article:
    toc: true
    toc_depth: 3
    code_folding: hide
    pandoc_args: ["--number-sections"]
---

\newcommand{\v}[1]{\boldsymbol{#1}}
\newcommand{\hat}[1]{\widehat{#1}}
\newcommand{\mm}[1]{\mathbb{#1}}
\newcommand{\bar}[1]{\overline{#1}}

\def\E{\Bbb{E}}
\def\V{\Bbb{V}}
\def\P{\Bbb{P}}
\def\I{{\large\unicode{x1D7D9}}}
\def\indep{\perp\!\!\!\!\perp}
\newcommand{\overeq}[2]{\stackrel{#1}{#2}}
\def\epsilon{\varepsilon} 

# Bayesian criteria for sample size

Let $\v{\mathfrak{X}} \ni \v{x} = (x_1,\dots,x_n)^{\top}$ and $\v{\theta} \in \v{\Theta}$ are a random sample with the size of $n$ and parameter of interest, respectively. The predictive distribution of $\{x_i\}_{i=1}^n$, i.e. pre-posterior distribution, is capable of obtaining from likelihood function as follows

$$
f(x_i) = \int_{\v{\Theta}} f(x|\v{\theta})d\v{\theta},
(\#eq:1)
$$
and the posterior distribution can be obtained 

$$
f(\v{\theta}|x) = \frac{f(x|\v{\theta})f(\v{\theta})}{f(x)},
(\#eq:2)
$$

\@ref(eq:2) also means

$$
f(\v{\theta}|x) \propto f(x|\v{\theta})f(\v{\theta}).
$$

The posterior coverage probability of region R with volume of V is given by 

$$
\int_{R}f(\v{\theta}|x)d\v{\theta},
$$

R is HPD iff $f(\v{\theta}_1|x) \ge f(\v{\theta}_2|x), \forall \v{\theta}_1 \in R, \v{\theta}_2 \notin R$. We now consider $\v{\Theta}$ is one-dimensional space, namely $\v{\theta}$ can be written as $\theta$. For the case of monotone increasing posterior densities defined on $(u,v)$, the corresponding condition for HPD is modified, see @joseph1995 for further detail. 

Three criteria considered in @joseph1995 are average coverage, average length and worst outcome, but we shall consider the average length criterion (ALC) in this review. Such a criterion is given by

$$
\int_{a(x,n)}^{a(x,n)+l'(x,n)}f(\theta|x)d\theta = 1-\alpha,
(\#eq:3)
$$

here we fix the coverage probability $1-\alpha$ of HPD credible set for $\theta$. Each $x$ will need a certain $l'(x,n)$ to reach the desired coverage probability. We then calculate the expectation of $l'(x,n)$ w.r.t predictive distribution $f(x)$ and such a expectation is less than or equal a pre-specified length $l$, 

$$
\int_{\mathfrak{X}}l'(x,n)f(x)dx \le l,
(\#eq:4)
$$

# Determine size size for normal distribution

## Single normal mean

Suppose we have a random vector $\v X = (X_1,X_2,\dots,X_n)$ that comprises exchangeable components following normal distribution with mean $\mu$ and precision $\lambda = 1/\sigma^2$. prior distributions of $\mu$ and $\lambda$ are 

$$
\lambda \sim \mathcal{Ga}(\nu,\beta),
(\#eq:5)
$$

and 

$$
\mu|\lambda \sim \mathcal{N}(\mu_0, n_0\lambda)
(\#eq:6)
$$

Here, we suppose both $\mu$ and $\tau$ are unknown, and marginal posterior distribution $\mu|\v x$ is 

$$
\mu|\v x \sim t_{2\nu+n}\sqrt{\frac{\beta_n}{(n+n_0)(\nu+n/2)}}+\mu_n,
(\#eq:7)
$$

where

$$
\mu_n = \frac{n_0\mu_0+n\bar{x}}{n+n_0}
$$

and 

$$
\beta_n = \beta+ \frac{1}{2}ns^2+\frac{1}{2}\frac{nn_0}{n+n_0}(\bar{x}-\mu_0)^2, \text{ where } ns^2 = \sum_{i=1}^n(x_i-\bar{x})^2
$$
SSD w.r.t ALC criterion is obtained in @joseph1997 as $n$ is sufficiently large such that 

$$
l \ge 2 t_{n+2\nu, 1-\alpha/2}\sqrt{\frac{2\beta}{(n+2\nu)(n+n_0)}}\frac{\Gamma(\frac{n+2\nu}{2})\Gamma(\frac{2\nu-1}{2})}{\Gamma(\frac{n+2\nu-1}{2})\Gamma(\nu)}
(\#eq:8)
$$

We shall now consider how to choose hyperparameters $\nu$ and $\beta$ for the precision $\lambda$. Suppose the aim is to obtain sample size of each treatment arm in a three-arm studies in which mean and standard deviation of outcome associated with each arm are known. This is,

```{r tab1}
if(!library(pacman, logical.return = T)) install.packages("pacman")
pacman::p_load(tidyverse, magrittr,HDInterval)
d<-
tibble(
  Agent = c("midazolam", "lidocaine", "placebo"),
  Mean = c(3.2,4,4.8),
  SE = c(2.9, 3.3,3.4),
  n = c(57,52,50)
)
knitr::kable(d, caption = "summary statistics obtained from other studies")
```

To calculate sample size of midazolam we suppose data $X \sim \mathcal{N}(\mu,\tau)$ where $\tau$ is precision, and

$$
\tau \sim \mathcal{Ga}(\nu, \beta),  \text{ and} \quad \mu|\tau \sim \mathcal{N}(\mu_{MI}, n_{MI}\tau),
(\#eq:9)
$$ 

where $\nu$ and $\beta$ are obtained by solving the following equations

$$
\begin{cases}
(\nu-1)\beta = \tau_{MI} \textit{ (mode of gamma distribution)}\\
\nu\beta^2 = S^2_{\tau_{MI}} \textit{ (variance of gamma distribution)}
\end{cases}
(\#eq:10)
$$

where 

$$
\begin{align}
&\tau_{MI} =1/ n_{MI}SE^2_{MI},\\
&S^2_{\tau_{MI}} = \frac{1}{2}\big[(\tau_{LI}-\tau_{MI})^2+(\tau_{PL}-\tau_{MI})^2\big].
\end{align}
$$


$\nu$ and $\beta$ can be solved analytically. We then can solve \@ref(eq:8) to obtain the sample size, or we can use \@ref(eq:9) to simulate data $\v x$ and calculate ALC. 
We shall now use information in Table \@ref(tab:tab1) to obtain $\nu$ and $\beta$. To this end, we calculate SD for each treatment

```{r tab2}
d%<>%
  mutate(SD = SE*sqrt(n), .before = "n")%>%
  mutate(SD = `names<-`(SD,Agent), `$$\\tau$$` = 1/SD^2)
kableExtra::kbl(d, caption = "SD of treatments")%>%
  kableExtra::kable_styling()
```

Solving \@ref(eq:10) we have 

$$
\beta = \frac{-\tau + \sqrt{\tau^2+4S^2_{\tau}}}{2},
$$

since product $\beta_1\beta_2 < 0$, $\beta_1$ and $\beta_2$ must have opposite signs. It means one of two roots must be a positive number.

We shall obtain $\beta$ and plot density function of $\tau$ with parameters $\nu$ and $\beta$.

```{r fig1, fig.cap="Density of Gamma distribution"}
tau = 1/d$SD[1]^2
s2 = mean((1/d$SD[2:3]^2-tau)^2)
beta = (-tau+sqrt(tau^2+4*s2))/2
nu = tau/beta+1
x = rgamma(5000, shape = nu, scale = beta)%>% sort()
plot(x,dgamma(x,shape = nu, scale = beta),
     xlab = "",
     col = "gray40", main = "", type = "l")
abline(v = (nu-1)*beta, col = "gray40")
abline(v =1/d$SD^2, col = "red", lty = 2)
```

Next, We use \@ref(eq:8) to obtain values of $l$ w.r.t to fixed values of $n$

```{r tab3}
n = seq(200,300, by = 10)
l<-
  sapply(n, function(i){
    p = lgamma((i+2*nu)/2)+ lgamma((2*nu-1)/2)-lgamma((i+2*nu-1)/2)-lgamma(nu)
    2*qt(0.975,i+2*nu)*sqrt(2*beta/(i+2*nu)/(i+d$n[1]))*exp(p)
})

tibble("Sample size" = n, "ALC" = l)%>%
  knitr::kable(caption = "sample size and average length criterion (analytical)")%>%
  kableExtra::kable_styling(
    bootstrap_options = c("striped", "hover"),
    full_width = TRUE)%>%
  kableExtra::scroll_box(width = "100%", height = "400px",
                         box_css = "align: center; ",
                         extra_css = "border: none; left: 200px; "
                         )
```

## Difference between two normal mean (common precision)

Suppose we have data $\v x_{12}^{\top} = (\v x_1^{\top},\v x_2^{\top})$, where $\v x_1 = (x_{11}, x_{21},\dots,x_{n_11})^{\top}$, $\v x_2 = (x_{12}, x_{22},\dots,x_{n_22})^{\top}$ and $x_{ij} \sim \mathcal{N}(\mu_j,\lambda)$ with $i = 1,2,\dots,n_j$, $j = 1,2$, note that $\lambda$ is precision. Again we suppose 

$$
\lambda \sim \mathcal{Ga}(\nu,\beta), \text{ and} \quad \mu_j|\lambda \sim \mathcal{N}(\mu_{0j}, n_{0j}\lambda)
(\#eq:11)
$$

Parameter of interest is $\theta = \mu_1-\mu_2$ and 

$$
\theta|\v x_{12} \sim A + \sqrt{\frac{B}{2CD}}t_{2C}
(\#eq:12)
$$

where

$$
\begin{align}
&A = \frac{n_2\bar{x}_2+n_{02}\mu_{02}}{n_2+n_{02}}\\
&B = 2\beta+n_1s^2_1+n_2s^2_2+\frac{n_1n_{01}}{n_1+n_{01}}(\bar{x}_1-\mu_{01})^2+\frac{n_2n_{02}}{n_2+n_{02}}(\bar{x}_2-\mu_{02})^2\\
&C = \frac{n_1+n_2}{2}+\nu\\
&D = \frac{(n_1+n_{01})(n_2+n_{02})}{n_1+n_{01}+n_2+n_{02}}
\end{align}
(\#eq:13)
$$

Thus, $n_1$ and $n_2$ can be obtained by solving following equations

$$
\begin{cases}
n_1+n_{01} = n_2+n_{02},\quad\textit{(minimize expected variance posterior)}\\
2t_{n_1+n_2+2\nu;1-\alpha/2}\sqrt{\frac{2\beta(n_1+n_{01}+n_2+n_{02})}{(n_1+n_2+2\nu)(n_1+n_{01})(n_2+n_{02})}}\frac{\Gamma\big(\frac{n_1+n_2+2\nu}{2}\big)\Gamma\big(\frac{2\nu-1}{2}\big)}{\Gamma\big(\frac{n_1+n_2+2\nu-1}{2}\big)\Gamma\big(\nu\big)} \le l
\end{cases}
(\#eq:14)
$$

$\nu$ and $\beta$ are obtained in a similar way to that in previous section. For example, we want to obtain $n_1$ and $n2$ that are sample size of midazolam and placebo, respectively. Thus $\nu$ and $\beta$ are roots of following equations 

$$
\begin{cases}
(\nu-1)\beta = \frac{1}{3}(\tau_{01}+\tau_{02}+\tau_{03}),\quad\textit{(mode)}\\
\nu\beta^2 = \frac{1}{2}\sum_{i=1}^3(\tau_{0i}-\bar{\tau}_0)^2,\quad\textit{(variance)}
\end{cases}
$$

```{r fig2, fig.cap="Density of Gamma distribution"}
s2 = var(pull(d,6))
tau0 = mean(pull(d,6))
beta = (-tau0+sqrt(tau0^2+4*s2))/2
nu = tau0/beta+1

x = rgamma(1000, shape = nu, scale = beta)%>% sort()
plot(x,dgamma(x,shape = nu, scale = beta), main = "", xlab = "", type = "l")
abline(v =tau0)
abline(v = pull(d,6), col = "red", lty = 2)
```

We now write $n_2$ in term of $n_1$ in first equation of \@ref(eq:14), i.e. $n_2 = n_1+n_{01}-n_{02}$. Next we plug this equation to second equation of \@ref(eq:14) and solve the equation.

```{r tab4}
n01 = d$n[1]; n02 = d$n[3] 

func = function(n){
  
  2*qt(0.975,n+n+n01-n02+2*nu)*sqrt(4*beta*(n+n01)/(2*n+n01-n02+2*nu)/(n+n01)/(n+n01))*exp(
    lgamma((2*n+n01-n02+2*nu)/2)+
    lgamma((2*nu-1)/2)-
    lgamma((2*n+n01-n02+2*nu-1)/2)-
    lgamma(nu)
  )
}
func = Vectorize(func)

n = seq(100,500, by = 10)

n1n2<-
tibble(n1 = n)%>%
  mutate(ALC = func(n))%>%
  mutate(n2 = n1+n01-n02, .before = "ALC")

n1n2%>%
  kableExtra::kbl(caption = "Sample size of midazolam, placebo.")%>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"), full_width = TRUE)%>%
  kableExtra::scroll_box(width = "100%", height = "400px",
                         box_css = "align: center; ",
                         extra_css = "border: none; left: 200px; "
                         )
```

Again, we use second equation in \@ref(eq:14) to calculate $n_3$, i.e. we plug all values of $n_2$ in the equation and search for $n_3$. Suppose we choose $n1$ and $n_2$ are `r pull(n1n2[4,1])` and `r pull(n1n2[4,2])`, respectively.

```{r tab5}
n2 = pull(n1n2[4,2])
n03 = d$n[2]

func2 = function(n1){
  p = lgamma((n1+n2+2*nu)/2)+lgamma((2*nu-1)/2)-lgamma((n1+n2+2*nu-1)/2)-lgamma(nu)
  2*qt(0.975,n1+n2+2*nu)*sqrt(2*beta*(n1+n01+n2+n02)/(n1+n2+2*nu)/(n1+n01)/(n2+n02))*exp(p)
}

n2n3<-
map2_dfr(n1n2$n1,n1n2$n2,~{
  tibble(n1 = .x, n2 = .y, n3 = c(.x,.x+3,.y))%>%
  mutate(ALC = func2(n3))
})%>%
  arrange(desc(ALC))

n2n3%>%
  kableExtra::kbl(caption =  paste0("Sample size of lidocaine when sample size of placebo is ",n2,"."))%>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"), full_width = TRUE)%>%
  kableExtra::scroll_box(width = "100%", height = "400px",
                         box_css = "align: center; ",
                         extra_css = "border: none; left: 200px; "
                         )
```

































<!-- # Determine size of one binomial sample -->

<!-- Suppose distribution of data $X$ and prior distribution of $\theta$ are $X \sim \mathcal{Bin}(n,\theta)$ and $\theta \sim \mathcal{Beta}(c,d)$, respectively. Thus we can show that posterior distribution of $\theta$ is -->

<!-- $$ -->
<!-- \theta|x,n,c,d \sim \mathcal{Beta}(c+x, d+n-x), -->
<!-- $$ -->

<!-- and preposterior marginal distribution is -->

<!-- $$ -->
<!-- p(x,n) = \binom{n}{x}\frac{B(c+x,d+n-x)}{B(c,d)}, -->
<!-- $$ -->

<!-- where $B(c,d) = \frac{\Gamma(c)\Gamma(d)}{\Gamma(c+d)}$. We then calculate -->

<!-- $$ -->
<!-- \int^{a(x,n)+l'(x,n)}_{a(x,n)}f(\theta|,x,n,c,d)d\theta = 1-\alpha -->
<!-- $$ -->

<!-- and -->

<!-- $$ -->
<!-- \sum^{n}_{x=0}l'(x,n)p(x,n) \le l, \quad \textit{(l is prespecified)} -->
<!-- $$ -->

<!-- (cont.) -->

















