---
title: "Generate Samples with Rjags"
description: "This note summarizes methods to generate samples and calculate measures of interest through such generated samples."
author:
  - name: Nam-Anh
date: "`r Sys.Date()`"
bibliography: citation.bib
csl: citation.csl
output:
  distill::distill_article:
    toc: true
    toc_depth: 3
    pandoc_args: ["--number-sections"]
    code_folding: hide
editor_options: 
  chunk_output_type: console
fontfamily: Arial
---

```{r setup, include=FALSE}
if(!library(pacman, logical.return = TRUE)) install.packages("pacman")
pacman::p_load(tidyverse, rjags, magrittr)
```


# Sampling with `rjags`

## Generalized t distribution

Suppose one wants to generate samples from generalized $t$ distribution whose density function is as follows

\begin{equation}
f(x) = \frac{c\sigma^{-1}}{\bigg[n+\Big(\frac{x-\theta}{\sigma}\Big)^2\bigg]^{0.5(n+1)}},
\end{equation}

one says $X \sim t(\theta,\sigma,n)$, where $\theta, \sigma$ and $n$ are location, scale parameter and degree of freedom.

To generate samples of $X$, one can use `rt` function in R to simulate from standard $t$ distribution and then transform such samples. one, however, now wants to simulate generalized $t$ distribution directly, which does not require an extra step of transformation. To this end, one employs `rjags` which is popular for obtaining samples from posterior distribution in Bayesian framework. 

It is worth noting that the generalized $t$ distribution function `dt` in `rjags` requires *mean* and *precision* rather than location and scale as its parameters. For example, one simulates samples from a generalized $t$ distribution whose mean and variance are 10 and 0.5, one shall need to plug in values of 10 and 1/0.5 as its first two parameters (third parameter is degree of freedom which equals 4). 

```{r,  message=FALSE, warning=FALSE}
model_string <- textConnection(
  "model{
 Y ~ dt(10,2,4)
}")
model <- jags.model(model_string, n.chains = 1, quiet = T)
#update(model, 1000, progress.bar="none")
params <- c("Y")
samples <- coda.samples(model,
                        variable.names=params,
                        n.iter=1000, progress.bar="none")

##################
x = samples[[1]][,1] %>% sort()
```

Let us compare with samples obtained by R function

```{r}
curve(wiqid::dt3(x,10, sqrt(0.5),4), xlim = c(0,20), lty = 3,, ylab = "density")
points(x,wiqid::dt3(x,10,sqrt(0.5),4), col = "red", type = "l", lty = 2)
```

## Transformation

One sometimes requires simulating samples from a transformed random variable, i.e one generates $Y = (2Z+1)^3$, where $Z \sim \mathcal{N}(0,1)$ and calculate $\mathbb{E}(Y)$ and $\mathbb{P}(Y \ge10)$. Such measures can be obtained analytically, more specifically $\mathbb{E}(Y) = 13$ and $\mathbb{P}(Y \ge 10) = 0.28$. @fouley2013

One now uses `rjags` to simulate samples 

```{r,  message=FALSE, warning=FALSE}
model_string <- textConnection(
  "model{
 Z ~ dnorm(0,1)
 Y <- pow(2*Z+1,3)
 P<- step(Y-10)
}")
model <- jags.model(model_string, n.chains = 1, quiet = T)
update(model, 1000, progress.bar="none")
params <- c("Y","P")
samples <- coda.samples(model,
                        variable.names=params,
                        n.iter=2000, progress.bar="none")

##################

exp_val = mean(samples[[1]][,2])
prob = mean(samples[[1]][,1])
```

and one obtained $\mathbb{E}(Y) =$ `r exp_val` and $\mathbb{P}(Y\ge 10) =$ `r prob`.

## A more complicated problem

Suppose one is required calculating how many items can be fixed with \$1000 given the cost to repair an item follows gamma distribution with mean $\mu = 100$ and standard deviation $\sigma = 50$, i.e

\begin{equation}
X \sim \mathcal{G}am(4, 0.04)
\end{equation}

one implements as follows

```{r,  message=FALSE, warning=FALSE}
model_string <- textConnection(
  "model{
  for(i in 1:n){Y[i] ~ dgamma(4,0.04)}
  sim[1]<- Y[1]
  for(i in 2:n){sim[i] <- sim[i-1]+Y[i]}
  for(i in 1:n){order[i]<- step(1000-sim[i])}
  item<- sum(order[])
  check <- step(sim[n]-1000)
  
}")
data = list(n=20)
model <- jags.model(model_string, n.chains = 1, data = data, quiet = T)
update(model, 1000, progress.bar="none")
params <- c("item","check")
samples <- coda.samples(model,
                        variable.names=params,
                        n.iter=10000, progress.bar="none")

##################

item = samples[[1]][,2] %>% mean()
check = samples[[1]][,1] %>% mean()
```

Mean of `item` is `r item` indicates there are about `r ceiling(item)` items which can be repaired, Mean of `check` equals 1 indicates $n=20$ is sufficient. 

# Prediction with unknown parameters

for the sake of ease, one shall consider a mixed distribution as follows

\begin{equation}
X = K\mathcal{N}(0,1) + (1-K)\mathcal{N}(5,1),
\end{equation}

where $K \sim \mathcal{B}er(0.3)$. Alternatively, above distribution can be rewritten as follows

\begin{equation}
f(x) = \int f(y|k)f(k)dk,
(\#eq:1)
\end{equation}

which is predictive prior distribution, where $k$ was defined above, and $Y|K=1 \sim \mathcal{N}(0,1)$ while $Y|K=0 \sim \mathcal{N}(5,1)$. To simulate samples of above distribution, one employs Bernoulli and Normal distributions as follows

```{r, eval = FALSE}
model_string <- textConnection(
  "model{
alpha ~ dbin(0.3,1)
x1 ~ dnorm(0,1)
x2 ~ dnorm(5,1)
# x = alpha*x1 + (1-alpha)*x2
x = ifelse(alpha==1,x1,x2)
}")

data = list(n=20)
model <- jags.model(model_string, n.chains = 1, quiet = T)
update(model, 1000, progress.bar="none")
params <- c("x","alpha")
samples <- coda.samples(model,
                        variable.names=params,
                        n.iter=10000, progress.bar="none")

samples[[1]][,2] %>% hist()
```

\@ref(eq:1) can be expended on distribution of $K$ that is known as prior distribution. For example, one wants to estimate, of 20 new students, how many ones will join painting club given the number of people joining the painting club follows Binomial distribution whose second paprameter follows Beta distribution. i.e

\begin{equation}
X \sim \mathcal{B}in(20,\pi), \quad \pi \sim \mathcal{B}eta(3,2).
\end{equation}

Thus, in `rjags` code one has 

```{r}
model_string <- textConnection(
  "model{
  p ~ dbeta(3,10)
  x ~ dbin(p,20)}"
  
  )

model <- jags.model(model_string, n.chains = 1, quiet = T)
update(model, 1000, progress.bar="none")
params <- c("x")
samples <- coda.samples(model,
                        variable.names=params,
                        n.iter=10000, progress.bar="none")

summary(samples)
```

hence, `r ceiling(mean(samples[[1]][,1]))` of 20 new students will join the club. If one wants to calculate probability that there is at least 2 students who will join the club, the result is

```{r}
mean(samples[[1]][,1]>=5)
```
















